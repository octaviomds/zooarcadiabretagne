tinymce.PluginManager.add("bf_layouts",function(e,t){let a,r=window.innerHeight>600?600:window.innerHeight-20;function i(i){let n="",s="Select Layout",u={text:"Cancel",type:"cancel"},l=[u,{text:"Insert",name:"Insert Layout",type:"custom",primary:!0}];if(i){s="Edit Layout",l=[u,{text:"Save",name:"Change Layout",type:"custom",primary:!0}];n=`?data=${encodeURIComponent(JSON.stringify({layoutData:JSON.parse(unescape(a.dataset.bfLayout))}))}`}e.windowManager.openUrl({title:s,url:`${t}/dialog.html${n}`,width:500,height:r,buttons:l,onAction(e,t){("Insert Layout"===t.name||"Change Layout"===t.name)&&e.sendMessage({message:"getLayout"})},onMessage(t,r){let n=r.data.content,s=r.mceAction;if(n&&"insertLayout"===s){let u=n.cssContent,l=e.dom.doc.body.querySelector("style[data-layout-name="+n.id+"]");if(i){!n.isRepeaterTurnedOn&&(a.hasAttribute("buildfire-repeat")?a.removeAttribute("buildfire-repeat"):a.querySelector("[buildfire-repeat]")&&a.querySelector("[buildfire-repeat]").removeAttribute("buildfire-repeat")),a.id=n.id,n.hasLinkData&&n.wasLinkDataPageOpened&&o({layoutData:n,layoutWrapperElement:a});let d={};d.id=n.id,d.cssUrl=n.cssUrl,d.htmlUrl=n.htmlUrl,d.wasDataLinked=n.hasLinkData,d.repeaterReplacementExpression=n.repeaterReplacementExpression;let c=escape(JSON.stringify(d));a.setAttribute("data-bf-layout",c),a.setAttribute("data-layout-name",n.id),e.selection.collapse(),e.isNotDirty=!1,e.fire("change")}else{let y=n.htmlContent,f=document.createElement("div");f.id=n.id,f.innerHTML=y,f.querySelectorAll("img").forEach(e=>{e.src=e.src&&e.src.replace("https://pluginserver.buildfire.com","https://pluginserver.appdocumentation.com"),e.setAttribute("src",e.src)}),n.hasLinkData&&o({layoutData:n,layoutWrapperElement:f});let p={};p.id=n.id,p.cssUrl=n.cssUrl,p.htmlUrl=n.htmlUrl,p.wasDataLinked=n.hasLinkData,p.repeaterReplacementExpression=n.repeaterReplacementExpression;let b=escape(JSON.stringify(p));f.setAttribute("data-bf-layout",b),f.setAttribute("data-layout-name",n.id),e.insertContent(f.outerHTML+"&nbsp;")}if(l)l&&i&&(l.innerHTML=u);else{let m=document.createElement("style");m.setAttribute("data-layout-name",n.id),m.innerHTML=u,e.dom.doc.body.appendChild(m)}t.close()}else if("showExpressionBuilder"===s){let L={string:r.data.string};buildfire.dynamic.expressions.showDialog(L,(e,a)=>{if(e)return console.error(e);a&&t.sendMessage({message:"insertExpression",expression:a})})}else"getLayoutElement"===s&&t.sendMessage({message:"sendLayoutHtml",layoutElement:a.outerHTML})}})}e.ui.registry.addButton("bf_edit_layout",{icon:"edit-block",tooltip:"Edit layout",onAction:function(){i(!0)}}),e.ui.registry.addContextToolbar("editBfLayout",{predicate:function(e){return e.dataset.bfLayout&&(a=e),e.dataset.bfLayout},items:"bf_edit_layout",position:"node",scope:"node"}),e.ui.registry.addMenuItem("bf_insertLayout",{text:"Insert layout",onAction:function(){i(!1)}}),e.ui.registry.addMenuItem("bf_editLayout",{text:"Edit layout",icon:"edit-block",onAction:function(){i(!0)}}),e.ui.registry.addMenuItem("bf_copyLayout",{text:"Copy layout",icon:"copy",onAction:function(){e.execCommand("mceSelectNode",!1,a),e.execCommand("Copy")}}),e.ui.registry.addMenuItem("bf_deleteLayout",{text:"Delete layout",icon:"remove",onAction:function(){a.parentNode.removeChild(a),e.isNotDirty=!1,e.fire("change")}}),e.ui.registry.addMenuItem("bf_insertBeforeLayout",{text:"Insert before layout",icon:"chevron-left",onAction:function(){a.insertAdjacentHTML("beforebegin","<p><br></p>")}}),e.ui.registry.addMenuItem("bf_insertAfterLayout",{text:"Insert after layout",icon:"chevron-right",onAction:function(){a.insertAdjacentHTML("afterend","<p><br></p>")}}),e.ui.registry.addContextMenu("bf_customLayouts",{update:function(e){if(e.dataset.bfLayout)return a=e,"bf_editLayout bf_copyLayout bf_deleteLayout bf_insertBeforeLayout bf_insertAfterLayout";for(;e.dataset.bfLayout||"BODY"!==e.nodeName;)if((e=e.parentElement)&&e.dataset){if(e.dataset.bfLayout)return a=e,"bf_editLayout bf_copyLayout bf_deleteLayout bf_insertBeforeLayout bf_insertAfterLayout"}else break;return""}});let o=e=>{let{layoutData:t,layoutWrapperElement:a}=e,r=t.repeaterReplacementExpression;if(r){let i=r.replace(/[?]/g,"").replace(/\.\[/g,"["),o=i.search(/\[[0-9]+\]/),n=i.slice(0,o),s=a.querySelector(t.repeatedSelector);if(s){s.setAttribute("buildfire-repeat",`layoutItem in ${n}`);a.querySelectorAll(t.repeatedSelector+":not([buildfire-repeat])").forEach(e=>e.remove())}else t.repeatedSelector==`div#${t.id}`&&a.setAttribute("buildfire-repeat",`layoutItem in ${n}`)}t.expressionFields.forEach(e=>{let t=e.value||"",i=a.querySelector(e.selector);i&&(r&&(t=t.replaceAll(r,"layoutItem")),e.attribute?"src"==e.attribute&&"IMG"==i.nodeName?t.search(/\${[^{}]*}/)>-1?i.setAttribute("data-expr-src",t):(i.removeAttribute("data-expr-src"),i.setAttribute("data-mce-src",t),i.setAttribute("src",t)):i.setAttribute(e.attribute,t):i.innerHTML=t)})};return{getMetadata:function(){return{name:"Layouts Plugin"}}}});