{"version":3,"sources":["../sdk/scripts/buildfire/services/gamify/scoreboard.js"],"names":["buildfire","gamify","Scoreboard","tagName","size","autoSubscribeToPushNotification","this","pushGroupName","prototype","getScoreboard","callback","publicData","get","err","result","data","topScores","undefined","gamesPlayed","reset","save","_PNEnabled","notifications","pushNotification","subscribe","cb","groupName","console","error","unsubscribe","logScore","user","score","warn","t","ts","Date","logError","rankedAt","newRec","createdOn","length","push","sort","a","b","bumpedOff","pop","update","id","i","obj","email","schedule","title","text","displayName","users"],"mappings":"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","file":"scoreboard.min.js","sourcesContent":["/**\n * Created by danielhindi on 1/18/18.\n */\n\nif (typeof (buildfire) == 'undefined') throw ('please add buildfire.js first to use BuildFire services');\nif (!buildfire.gamify) buildfire.gamify = {};\n\n\nbuildfire.gamify.Scoreboard = function(tagName,size,autoSubscribeToPushNotification){\n\tthis.size=size || 10;\n\tthis.autoSubscribeToPushNotification=autoSubscribeToPushNotification;\n\tif(this.size < 1)this.size=10;\n\tthis.tagName = tagName || 'scoreboard';\n\tthis.pushGroupName = 'scoreboard_' + this.tagName;\n};\n\nbuildfire.gamify.Scoreboard.prototype = {\n\tsize:10\n\t,getScoreboard:function(callback){\n\t\tbuildfire.publicData.get(this.tagName, function (err, result) {\n\n\t\t\tif(err)\n\t\t\t\tcallback(err);\n\t\t\telse {\n\t\t\t\tif (result.data.topScores)\n\t\t\t\t\tcallback(undefined,result.data);\n\t\t\t\telse\n\t\t\t\t\tcallback(undefined,{\n\t\t\t\t\t\tgamesPlayed:0\n\t\t\t\t\t\t,topScores: []\n\t\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\t,reset:function(){\n\t\tvar data = {\n\t\t\tgamesPlayed:0\n\t\t\t,topScores: []\n\t\t};\n\t\tbuildfire.publicData.save(data,this.tagName, function(){});\n\t}\n\t, _PNEnabled:function(){\n\t\treturn buildfire.notifications && buildfire.notifications.pushNotification;\n\t}\n\t,subscribe:function(cb){\n\t\t/// if PushNotifications are available then subscribe to the group\n\t\tif(this._PNEnabled()) {\n\t\t\tbuildfire.notifications.pushNotification.subscribe({groupName: this.pushGroupName}, function (err) {\n\t\t\t\tif (err) console.error(err);\n\t\t\t\tif(cb)cb(err);\n\t\t\t});\n\t\t\treturn true;\n\t\t}else\n\t\t\treturn false;\n\t}\n\t,unsubscribe:function(cb){\n\t\t/// if PushNotifications are available then unsubscribe from the group\n\t\tif(this._PNEnabled()) {\n\t\t\tbuildfire.notifications.pushNotification.unsubscribe({groupName: this.pushGroupName}, function (err) {\n\t\t\t\tif (err) console.error(err);\n\t\t\t\tif(cb)cb(err);\n\t\t\t});\n\t\t\treturn true;\n\t\t}else\n\t\t\treturn false;\n\t}\n\t,logScore: function (user, score,callback) {\n\n\t\tif(this.autoSubscribeToPushNotification){\n\t\t\tif(!this.subscribe()){\n\t\t\t\tconsole.warn('Cannot subscribe to scoreboard push notifications because buildfire push notification services is not attached');\n\t\t\t}\n\t\t}\n\n\t\tvar t= this;\n\t\tvar ts = new Date();\n\t\tbuildfire.publicData.get(this.tagName, function (err, result) {\n\t\t\tfunction logError(err){\n\t\t\t\tif(err){\n\t\t\t\t\tcallback(err);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar newRec={user: user, score: score, createdOn:ts};\n\n\t\t\tvar data = {\n\t\t\t\tgamesPlayed:0\n\t\t\t\t,topScores: [newRec]\n\t\t\t};\n\t\t\tif (err)\n\t\t\t\tcallback(err);\n\t\t\telse if (result) {\n\n\t\t\t\tif(!result.data.topScores){\n\t\t\t\t\tdata.gamesPlayed++;\n\t\t\t\t\tbuildfire.publicData.save(data, t.tagName,logError );\n\t\t\t\t}\n\t\t\t\telse{\n\n\n\t\t\t\t\t/// check if your score is greater than the lowest one\n\t\t\t\t\tif(result.data.topScores.length > t.size){\n\t\t\t\t\t\tif(result.data.topScores[t.size -1].score > score) /// nothing to do here you didnt make the list\n\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t}\n\n\t\t\t\t\tdata = result.data;\n\t\t\t\t\tdata.topScores.push(newRec);\n\t\t\t\t\tdata.topScores= data.topScores.sort(function (a, b) {\n\t\t\t\t\t\treturn b.score - a.score ;\n\t\t\t\t\t});\n\n\t\t\t\t\tvar bumpedOff;\n\t\t\t\t\tif(data.topScores.length > t.size)\n\t\t\t\t\t\tbumpedOff = data.topScores.pop();\n\n\t\t\t\t\tdata.gamesPlayed++;\n\t\t\t\t\tbuildfire.publicData.update(result.id, data, t.tagName, logError);\n\n\t\t\t\t\tvar rankedAt;\n\t\t\t\t\tfor(var i = 0; i < data.topScores.length ;i++){\n\t\t\t\t\t\tif(data.topScores[i].createdOn == ts){\n\t\t\t\t\t\t\trankedAt = i;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tvar obj={bumpedOff:bumpedOff, rankedAt:rankedAt};\n\n\t\t\t\t\tif(t._PNEnabled()) {\n\n\t\t\t\t\t\tif( obj.bumpedOff && obj.bumpedOff.user.email != user.email){\n\n\t\t\t\t\t\t\t//send notification\n\t\t\t\t\t\t\tbuildfire.notifications.pushNotification.schedule({\n\t\t\t\t\t\t\t\ttitle: 'You got kicked off !!!'\n\t\t\t\t\t\t\t\t,text: 'Your old score is no longer on the top 10. ' + user.displayName + ' has taken your spot. Honestly, I dont know how you sleep at night.'\n\t\t\t\t\t\t\t\t//,at: new Date()\n\t\t\t\t\t\t\t\t,users:[obj.bumpedOff.user.id]\n\t\t\t\t\t\t\t},logError);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(rankedAt == 0) {\n\t\t\t\t\t\t\tbuildfire.notifications.pushNotification.schedule({\n\t\t\t\t\t\t\t\ttitle: 'There is a new champion!'\n\t\t\t\t\t\t\t\t,text: user.displayName + ' has taken the lead at the new undisputed champion with a score of ' + score\n\t\t\t\t\t\t\t\t,groupName: t.pushGroupName\n\t\t\t\t\t\t\t}, logError);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(rankedAt == 1) {\n\t\t\t\t\t\t\tbuildfire.notifications.pushNotification.schedule({\n\t\t\t\t\t\t\t\ttitle: 'There is a challenger to the champion'\n\t\t\t\t\t\t\t\t, text: user.displayName + ' has taken 2nd place with a score of ' + score + '. Watch out ' + data.topScores[0].user.displayName\n\t\t\t\t\t\t\t\t, groupName: t.pushGroupName\n\t\t\t\t\t\t\t}, logError);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(rankedAt == 2) {\n\t\t\t\t\t\t\tbuildfire.notifications.pushNotification.schedule({\n\t\t\t\t\t\t\t\ttitle: 'There is a kid in town!'\n\t\t\t\t\t\t\t\t, text: user.displayName + ' has taken 3rd place. Keep an eye on this one'\n\t\t\t\t\t\t\t\t, groupName: t.pushGroupName\n\t\t\t\t\t\t\t}, logError);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback(null,obj);\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata.gamesPlayed++;\n\t\t\t\tbuildfire.publicData.save(data,t.tagName, logError);\n\t\t\t\tcallback(null,{rankedAt:0});\n\t\t\t}\n\n\t\t});\n\t}\n};"]}